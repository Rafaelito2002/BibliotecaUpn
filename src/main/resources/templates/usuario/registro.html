<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<meta name="description" content="">
	<meta name="author" content="">

	<title>Jose Bento</title>

	<!-- Bootstrap core CSS -->
	<link th:href="@{/vendor/bootstrap/css/bootstrap.min.css}" rel="stylesheet">

	<!-- Custom styles for this template -->
	<link th:href="@{/css/heroic-features.css}" rel="stylesheet">
	<link th:href="@{/css/style.css}" rel="stylesheet">
</head>

<body>

	<!-- Navigation -->
	<nav class="navbar navbar-expand-lg navbar-light fixed-top" style="background-color: blue;">
		<div class="container">
			<a class="navbar-brand"  style="color: white;" th:href="@{/}">Biblioteca Jose Bento</a>
			<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive"
				aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
				<span class="navbar-toggler-icon"></span>
			</button>
			<div class="collapse navbar-collapse" id="navbarResponsive">
				<ul class="navbar-nav ml-auto">
					<li   class="nav-item">
						<a class="nav-link" th:href="@{/usuario/login}" style="color: white;">Login</a>
					</li>
				</ul>
			</div>
		</div>
	</nav>

	<!-- Page Content -->
	<div class="container-fluid login-container">
		<!-- Imagen a la izquierda -->
		<div class="register-image">
		</div>

		<!-- Formulario de registro a la derecha -->
		<div class="register-form">
			<h2 class="register-header">Registro</h2>
			
			<!-- Mostrar errores si existen -->
			<div th:if="${error}" class="alert alert-danger" role="alert">
				<p th:text="${error}"></p>
			</div>

			<form th:action="@{/usuario/save}" method="post">
				<div class="form-group">
					<label for="nombres">Nombres:</label>
					<input type="text" class="form-control" id="nombre" name="nombre" required placeholder="Ingrese sus nombres" autocomplete="off">
				</div>
				<div class="form-group">
					<label for="apellido">Apellidos:</label>
					<input type="text" class="form-control" id="apellidos" name="apellidos" required placeholder="Ingrese sus apellidos" autocomplete="off">
				</div>

				<div class="form-group">
					<label for="email">Email:</label>
					<input type="email" class="form-control" id="email" name="email" required placeholder="Ingrese su email" autocomplete="off">
				</div>

				<div class="form-group">
					<label for="direccion">Dirección:</label>
					<input type="text" class="form-control" id="direccion" name="direccion" required placeholder="Ingrese su dirección" autocomplete="off">
				</div>

				<div class="form-group">
					<label for="pwd">Contraseña:</label>
					<input type="password" class="form-control" id="password" name="password" required placeholder="Ingrese su contraseña" autocomplete="off">
				</div>

				<div class="form-group">
					<button type="submit" class="btn btn-success btn-block">Guardar</button>
				</div>
			</form>
		</div>
	</div>

	<!-- Agregar el modal antes del cierre del body -->
<div class="modal fade" id="welcomeModal" tabindex="-1" role="dialog" aria-labelledby="welcomeModalLabel" aria-hidden="true">
	<div class="modal-dialog" role="document">
	  <div class="modal-content">
		<div class="modal-header">
		  <h5 class="modal-title" id="welcomeModalLabel">¡Registro Exitoso!</h5>
		  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
			<span aria-hidden="true">&times;</span>
		  </button>
		</div>
		<div class="modal-body">
		  <p>¡Bienvenido/a <span id="fullName" class="font-weight-bold"></span> a la Biblioteca Jose Bento!</p>
		  <p class="text-muted">Tu cuenta ha sido creada exitosamente.</p>
		</div>
		<div class="modal-footer">
		  <button type="button" class="btn btn-success" data-dismiss="modal">Continuar</button>
		</div>
	  </div>
	</div>
  </div>
  
  <!-- Agregar el script antes del cierre del body -->
  <script>
  document.querySelector('form').addEventListener('submit', async function(event) {
	  event.preventDefault();
	  
	  // Validaciones del nombre
	  const nombre = document.getElementById('nombre').value.trim();
	  const apellidos = document.getElementById('apellidos').value.trim();
	  const password = document.getElementById('password').value;
	  
	  // Validación de nombre
	  if (nombre.length < 3) {
		  showError("El nombre debe tener al menos 3 caracteres");
		  return;
	  }
	  
	  if (!nombre.match(/^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+$/)) {
		  showError("El nombre contiene caracteres no permitidos");
		  return;
	  }
	  
	  // Validación de contraseña
	  if (password.length < 8) {
		  showError("La contraseña debe tener al menos 8 caracteres");
		  return;
	  }
	  
	  if (!password.match(/.*[!@#$%^&*(),.?":{}|<>].*/)) {
		  showError("La contraseña debe incluir al menos un carácter especial");
		  return;
	  }
	  
	  if (!password.match(/.*[A-Z].*/)) {
		  showError("La contraseña debe incluir al menos una letra mayúscula");
		  return;
	  }
	  
	  if (!password.match(/.*\d.*/)) {
		  showError("La contraseña debe incluir al menos un número");
		  return;
	  }
  
	  try {
		  const formData = new FormData(this);
		  const response = await fetch(this.action, {
			  method: 'POST',
			  body: formData
		  });
  
		  if (response.ok) {
			  const data = await response.json();
			  // Mostrar el modal con el nombre completo
			  document.getElementById('fullName').textContent = `${nombre} ${apellidos}`;
			  $('#welcomeModal').modal('show');
			  
			  // Cuando se cierre el modal, redirigir
			  $('#welcomeModal').on('hidden.bs.modal', function (e) {
				  window.location.href = '/';
			  });
		  } else {
			  const error = await response.text();
			  showError(error);
		  }
	  } catch (error) {
		  console.error('Error:', error);
		  showError("Ocurrió un error al procesar el registro");
	  }
  });
  
  function showError(message) {
	  const errorDiv = document.querySelector('.alert-danger') || document.createElement('div');
	  errorDiv.className = 'alert alert-danger';
	  errorDiv.role = 'alert';
	  errorDiv.innerHTML = `<p>${message}</p>`;
	  
	  const form = document.querySelector('form');
	  if (!document.querySelector('.alert-danger')) {
		  form.insertBefore(errorDiv, form.firstChild);
	  }
  }
  </script>







	<!-- Footer -->
	<div th:include="usuario/template_usuario.html::footer"></div>

	<!-- Bootstrap core JavaScript -->
	<script th:src="@{/vendor/jquery/jquery.min.js}"></script>
	<script th:src="@{/vendor/bootstrap/js/bootstrap.bundle.min.js}"></script>

</body>
</html>
